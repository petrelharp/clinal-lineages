---
title: "Brownian local times"
date: "`r date()`"
---

$$
\newcommand{\E}{\mathbb{E}}
\renewcommand{\P}{\mathbb{P}}
\DeclareMathOperator{\sgn}{sgn}
$$

```{r doc_setup, include=FALSE}
fig.dim <- 5
knitr::opts_chunk$set(fig.width=2*fig.dim,fig.align='center')
```

Killing at Brownian local times
===============================

It states in [Takacs](https://projecteuclid.org/euclid.aoap/1177004703) that 
if $\tau(x)$ is the local time at $x$ for Brownian motion run for time 1 and begun at 0,
i.e.,
$$
\begin{align*}
    \tau(x) = \lim_{\epsilon \to 0} \frac{1}{\epsilon}
        \text{measure}\{t \,:\, x \le B_t \le x+\epsilon, \, 0 \le t \le 1\}
\end{align*}
$$
then
$$
\begin{align*}
    \P\{ \tau(x) \le u \} = 2 \Phi(|x|+u)-1,
\end{align*}
$$
where $\Phi(x)=\P\{B_1 \le x\}$ is the Gaussian CDF.
Differentiating this, $\P\{\tau \in du\} = \partial_u \P\{\tau \le u\}$, so
$$
\begin{align*}
    \P\{ \tau(x) = 0 \} &= 2 \Phi(|x|)-1 \\
    \P\{ \tau(x) \in du \} &= 2 \phi(|x|+u) ,
\end{align*}
$$
where $\phi$ is the Gaussian density.

Let's check this:
```{r sim_rw, cache=TRUE}
nwalks <- 1e4
ntimes <- 1e3
# want total time to be 1, so:
eps <- 1/sqrt(ntimes)
rws <- matrix( rnorm(nwalks*ntimes)*eps, nrow=ntimes, ncol=nwalks )
rws <- rbind(0,apply(rws,2,cumsum))
matplot(rws[,1:20],type='l', ylab='position')
```
Here we've simulated `r nwalks` random walks for a total of `r ntimes` steps,
and scaled steps to have this be a total Brownian time of 1.
Let's check:
```{r final_dist}
xh <- hist(rws[ntimes,],breaks=50)
lines( xh$mids, sum(xh$counts)*diff(pnorm(xh$breaks)) )
```

Now, let's check on the local time formula.
The number of steps the random walk spends at position $k$ on a grid with spacing $\epsilon$
and a time step of \gamma
should be $\epsilon \times \tau(k\epsilon) / \gamma$.
First, the local time at 0:
```{r local_times_0, cache=TRUE, depends="sim_rw"}
xh <- hist(colSums(abs(rws)<=1.5*eps)/ntimes/(3*eps),main="local time at 0", breaks=30)
lines( xh$mids, sum(xh$counts)*diff( 2*pnorm(xh$breaks)-1 ), col='red' )
```
What about the local time at other locations?
Note there is an atom at 0, now,
and that the discretization could trip us up;
the colors (red/green/blue) use the (mid/upper/lower) points of the interval that we count in.
```{r local_times, cache=TRUE, depends="sim_rw"}
layout(matrix(1:4,nrow=2))
for (loc in c(0.1, 0.2, 0.4, 0.6)) {
    lts <- colSums(abs(rws-loc)<=1.5*eps)/ntimes/(3*eps)
    zeros <- (lts==0)
    pred.zero <- 2*pnorm(abs(loc)+c(0,1.5*eps,-1.5*eps))-1
    xh <- hist(lts[!zeros],main=paste("local time at",loc), breaks=30, ylim=range(c(0,pred.zero*nwalks)))
    lines( xh$mids, sum(!zeros)*diff( 2*pnorm(abs(loc)+xh$breaks)-1 ), col='red' )
    points(rep(0,4), c(sum(zeros),pred.zero*nwalks), col=1:4, pch=20, cex=2)
    # lower bound
    lines( xh$mids, sum(!zeros)*diff( 2*pnorm(abs(loc+1.5*eps)+xh$breaks)-1 ), col=3 )
    # upper bound
    lines( xh$mids, sum(!zeros)*diff( 2*pnorm(abs(loc-1.5*eps)+xh$breaks)-1 ), col=4 )
}
```
Clearly, the discretization is still tripping us up a bit,
but it's pretty good.

Its Laplace transform
=====================

Now suppose that something happens at rate $r$ relative to the local time at $x$
(e.g., recombination to the other background).
Then the chance that this has not happened by time 1 is
$$
\begin{align*}
\E\left[ e^{-r\tau(x)} \right]
&=
2\Phi(|x|)-1 + 
\int_0^\infty e^{-rt} 2 \phi(|x|+t) dt \\
&=
2\Phi(|x|)-1 + 
e^{r|x|} \int_{|x|}^\infty e^{-rt} 2 \phi(t) dt \\
&=
2\Phi(|x|)-1 + 
2 e^{r|x|} \int_{|x|}^\infty \frac{1}{\sqrt{2\pi}} \exp\left( - rt - t^2/2 \right) dt \\
&=
2\Phi(|x|)-1 + 
2 e^{r|x|+r^2/2} \int_{|x|}^\infty \frac{1}{\sqrt{2\pi}} \exp\left( - (t+r)^2/2 \right) dt \\
&=
2\Phi(|x|)-1 + 
2 e^{r|x|+r^2/2} \left( 1-\Phi(|x|+r) \right) .
\end{align*}
$$
At $r=0$ this equals 1, as it should, since it's the chance that nothing happens.
For large $x$, since $1-\Phi(x) \sim e^{-x^2/2}/\sqrt{2\pi}x$,
this is approximately 
$1 + 2 \exp( r|x| + r^2/2 - (|x|+r)^2/2 )$,
which goes to 1, as it should.


Let's check that, too: why not?
```{r killing, cache=TRUE, depends="sim_rw"}
loc <- 0.1
zeta <- function (x,r) {
    2*pnorm(abs(x)) - 1 + 2 * exp( r*abs(x) + r^2/2 + pnorm(abs(x)+r,lower.tail=FALSE,log.p=TRUE) )
}
compare.rates <- as.data.frame( t( sapply( c(0.25,0.5,1,1.5,2,2.5,3), function (rate) {
        visits <- colSums(abs(rws-loc)<=1.5*eps)
        killed <- ( rbinom(ncol(rws),size=visits,prob=rate/ntimes/(3*eps)) == 0 )
        c( 
          rate=rate,
          simulation=mean(killed), 
          theory=zeta(loc,rate),
          SE=sqrt(mean(killed)*(1-mean(killed))/nwalks)
          )
    } ) ) )
with(compare.rates, {
         plot( rate, theory, type='l', xlab="recomb rate", ylab="prob of recomb", col='red', ylim=c(0,1) ) 
         points( rate, simulation, pch=20 )
         arrows( x0=rate, y0=simulation-2*SE, y1=simulation+2*SE, angle=90, code=3 )
    } )
```

This is very steep at $x=0$.
Notice that as $x$ goes to 0,
$$
\begin{align*}
    \lim_{x \to 0} \zeta(x,r) 
    &= 2 e^{r^2/2} (1-\Phi(r)) \\
    &= \frac{2}{r\sqrt{2\pi}} + O(r^{-3}) .
\end{align*}
$$
so that the difference in the left and right limits is
$$
\begin{align*}
    \lim_{x \to 0-} p(x,r) 
    -\lim_{x \to 0+} p(x,r) 
    &= 
    \frac{1}{2}+\frac{2}{r\sqrt{2\pi}} 
    - \frac{1}{2}-\frac{2}{r\sqrt{2\pi}} 
      +O(r^{-3}) \\
    &=
    \frac{4}{r\sqrt{2\pi}}
      +O(r^{-3}) 
\end{align*}
$$

Let's also look at the slope of $p$ at $x=0$.
Since $\partial_x |x| = \sgn(x)$,
$$
\begin{align*}
    \partial_x \zeta(x,r)
    &=
    2 \sgn(x) \left(
    \phi(|x|)
    + r e^{r|x|+r^2/2} (1-\Phi(|x|+r))
    - e^{r|x|+r^2/2} \phi(|x|+r)
      \right)
\end{align*}
$$
and so
$$
\begin{align*}
    -\partial_x p(x)
    &=
    \phi(|x|)
    + r e^{r|x|+r^2/2} (1-\Phi(|x|+r))
    - e^{r|x|+r^2/2} \phi(|x|+r) \\
    &\to
    \frac{1}{\sqrt{2\pi}}(1-e^{r^2/2}e^{-r^2/2})
    + r e^{r^2/2} (1-\Phi(r))  \qquad \text{as } x \to 0 \\
    &=
    r e^{r^2/2} (1-\Phi(r)) \\
    &=
    \frac{1}{\sqrt{2\pi}} + O(\frac{1}{r}) .
\end{align*}
$$


What this says about clines
===========================

The above restricted to standard Brownian motion on one unit of time.
Really, we will want to use this across $\tau$ generations,
modeling a random walk with variance $\sigma^2$ per generation.

The key quantity we want is the probability that a Brownian motion with variance $\sigma^2$ killed at rate $r$
with respect to its local time at $x$ was still alive at time $\tau$.
Denote this by
$$
\begin{align*}
    \zeta(x,r,\tau,\sigma).
\end{align*}
$$
By Brownian scaling,
since $B_{ct}$ has the same distribution as $\sqrt{c}B_t$,
$$
\begin{align*}
    \zeta(x,r,\tau,\sigma) 
    &=
    \zeta(x,r\tau,1,\sqrt{\tau}\sigma) \\
    &=
    \zeta(x/\sqrt{\tau\sigma^2},r\tau,1,1) ,
    % &=
    % 2 \exp\left(r\tau\left(\frac{|x|}{\sqrt{\tau}\sigma}+\frac{r\tau}{2}\right)\right) \left( 1-\Phi\left(\frac{|x|}{\sqrt{\tau\sigma^2}}+r\tau \right) \right) .
\end{align*}
$$
and
$$
\begin{align*}
    \zeta(x,r,1,1)
    &=
    1 - 2(1-\Phi(|x|)) + 
    2 e^{r|x|+r^2/2} \left( 1-\Phi(|x|+r) \right) .
\end{align*}
$$

Now, let $p(x,r,\tau,A)$ denote the probability that a lineage begun at $x<0$
at a location at recombination distance $r$ from the selected site
inherits from the left-hand side of the barrier
(i.e., an ancestor on $(-\infty,0)$)
$\tau$ generations ago.
For an individual to the left of the barrier ($x<0$),
this is the probability no recombination at the barrier has occurred
plus one-half the probability recombination has occurred,
i.e., $\zeta+(1-\zeta)/2=(1+\zeta)/2$.
If $x>0$ this is the one-half times probability a recombination has occurred,
i.e., $(1-\zeta)/2$.
Combining these,
the probability of ending up on the left-hand side is
$$
\begin{align*}
    p(x,r,\tau,A) = 
    \frac{1}{2} \left\{ 1 - \sgn(x) \zeta(x,r,\tau) \right\} .
\end{align*}
$$

Does this actually make a cline?
```{r show_cline}
pcline <- function (x,r,tau=1,sigma=1) {
    (1/2)*( 1 - sign(x)*zeta(x=x/sqrt(tau*sigma^2),r=r*tau) )
}
xx <- seq(-5,5,length.out=500)
plot(xx, pcline(xx,r=1), type='l', xlab="distance from cline center", ylab="prob of inherited from the left" )
rr <- seq(0,2,length.out=11)
pp <- sapply( rr, function (r) { pcline(xx,r=r) } )
matplot(xx,pp,type='l',lty=1,col=rainbow(length(rr)),add=TRUE)
legend("topright",lty=1,col=rainbow(length(rr)),legend=paste("r=",rr))
```
